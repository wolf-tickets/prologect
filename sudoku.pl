% CPSC 312 - Project #2 (Prolog)
% Sudoku solver for 9x9 and 25x25 puzzles
% (TODO? extend to  arbitrary square dimensions)
% Implementation uses a defined finite domain and constraint logic via the clpfd module


% Import constraint logic module for clpfd implementation
:- use_module(library(clpfd)).

% Sample puzzle.
puzzle_25([[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]).

puzzle_9([[_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_]]).


puzzle_25_a([[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,4,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,16,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,25,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,17,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
           [_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]).

puzzle_9_a([[_,_,_,_,_,5,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,6,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [8,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,9]]).
puzzle_9_b([[_,_,_,_,_,5,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,6,_,_,_,2],
            [_,_,8,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,1,_,_,_],
            [8,_,_,_,_,_,_,_,_],
            [_,_,_,_,_,_,_,_,9]]).
todays_puzzle([[_,_,_,_,9,_,_,2,3],
               [_,_,_,1,_,_,_,6,_],
               [6,4,5,_,8,_,_,_,_],
               [_,_,_,5,_,_,7,9,1],
               [_,_,_,_,_,_,_,_,_],
               [8,2,1,_,_,7,_,_,_],
               [_,_,_,_,5,_,3,1,7],
               [_,1,_,_,_,4,_,_,_],
               [7,8,_,_,3,_,_,_,_]]).

% Puzzle is represented by a list of lists, so individual cells are identified
% by (row, column) coordinates; rows are letters, columns are numbers.

% sudoku_clpfd: takes a puzzle and returns solutions using clpfd
sudoku_clpfd_25(Puzzle) :-
    flatten(Puzzle, Dom),
    Dom ins 1..25,
    Rows = Puzzle,
    maplist(all_distinct, Rows),
    transpose(Rows, Columns),
    maplist(all_distinct, Columns),
    Rows = [A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y],
    subsquare(A, B, C, D, E),
    subsquare(F, G, H, I, J),
    subsquare(K, L, M, N, O),
    subsquare(P, Q, R, S, T),
    subsquare(U, V, W, X, Y),
    maplist(label, Rows).
    maplist(writef, Rows).

sudoku_clpfd_9(Puzzle) :-
    flatten(Puzzle, Dom),
    Dom ins 1..9,
    Rows = Puzzle,
    maplist(all_distinct, Rows),
    transpose(Rows, Columns),
    maplist(all_distinct, Columns),
    Rows = [AA, BB, CC, DD, EE, FF, GG, HH, II],
    subsquare(AA, BB, CC),
    subsquare(DD, EE, FF),
    subsquare(GG, HH, II),
    maplist(label, Rows).
    maplist(portray_clause, [AA, BB, CC, DD, EE, FF, GG, HH, II]).


% subsquare: takes one puzzle, returns a number of subsquares equal to the
% dimensions of the puzzle.
subsquare([],[],[],[],[]).
subsquare([A1,A2,A3,A4,A5|Ar],
          [B1,B2,B3,B4,B5|Br],
          [C1,C2,C3,C4,C5|Cr],
          [D1,D2,D3,D4,D5|Dr],
          [E1,E2,E3,E4,E5|Er]) :-
                    all_distinct([A1,A2,A3,A4,A5,
                                 B1,B2,B3,B4,B5,
                                 C1,C2,C3,C4,C5,
                                 D1,D2,D3,D4,D5,
                                 E1,E2,E3,E4,E5]),
                    subsquare(Ar,Br,Cr,Dr,Er).
subsquare([],[],[]).
subsquare([A1,A2,A3|Ar],
          [B1,B2,B3|Br],
          [C1,C2,C3|Cr]) :-
                    all_distinct([A1,A2,A3,
                                 B1,B2,B3,
                                 C1,C2,C3]),
                    subsquare(Ar,Br,Cr).


% solves the puzzle and prints it.
solve_and_print_9(P) :- sudoku_clpfd_9(P), print_grid(P).
solve_and_print_25(P) :- sudoku_clpfd_25(P), print_grid(P).

% helper procedure to print out each row on a separate line.
print_grid([]).
print_grid([H|T]) :- portray_clause(H), print_grid(T).